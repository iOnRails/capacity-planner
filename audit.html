<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Activity Log ‚Äî Capacity Planner</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --bg1: #181a20; --bg2: #23262f; --bg3: #2c2f3a;
    --text1: #f4f4f5; --text2: #a0a3b1; --accent: #6c63ff;
    --border: #33364a; --red: #ff6b6b; --green: #51cf66; --orange: #ffa94d;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg1); color: var(--text1); min-height: 100vh; }

  /* Auth gate */
  .auth-gate { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; gap: 24px; }
  .auth-gate h2 { color: var(--text2); font-weight: 400; font-size: 18px; }

  /* Header */
  .header { display: flex; align-items: center; justify-content: space-between; padding: 12px 24px; background: var(--bg2); border-bottom: 1px solid var(--border); }
  .header h1 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .header h1 span { color: var(--text2); font-weight: 400; font-size: 13px; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .header-right img { width: 24px; height: 24px; border-radius: 50%; }
  .header-right .user-name { font-size: 12px; color: var(--text2); }
  .back-link { color: var(--accent); text-decoration: none; font-size: 13px; }
  .back-link:hover { text-decoration: underline; }
  .logout-btn { background: none; border: 1px solid var(--border); color: var(--text2); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; }
  .logout-btn:hover { border-color: var(--text2); color: var(--text1); }

  /* Filters */
  .filters { display: flex; align-items: center; gap: 12px; padding: 12px 24px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-wrap: wrap; }
  .filter-group { display: flex; align-items: center; gap: 6px; }
  .filter-group label { font-size: 12px; color: var(--text2); }
  .filter-group select, .filter-group input { background: var(--bg3); border: 1px solid var(--border); color: var(--text1); padding: 5px 8px; border-radius: 4px; font-size: 12px; }
  .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--accent); }
  .refresh-btn { background: var(--accent); border: none; color: #fff; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 500; }
  .refresh-btn:hover { opacity: 0.9; }
  .entry-count { font-size: 12px; color: var(--text2); margin-left: auto; }

  /* Table */
  .log-container { padding: 16px 24px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th { text-align: left; padding: 8px 12px; color: var(--text2); font-weight: 500; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: var(--bg1); }
  tbody td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tbody tr:hover { background: var(--bg2); }
  .ts { color: var(--text2); font-size: 12px; white-space: nowrap; }
  .user-cell { display: flex; align-items: center; gap: 6px; }
  .user-email { color: var(--text2); font-size: 11px; }
  .vertical-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; background: var(--bg3); color: var(--text2); text-transform: capitalize; }
  .action-cell { font-weight: 500; }
  .details-cell { color: var(--text2); font-size: 12px; max-width: 500px; word-break: break-word; }
  .details-summary { cursor: pointer; display: flex; align-items: center; gap: 6px; }
  .details-summary:hover { color: var(--text1); }
  .details-toggle { font-size: 10px; color: var(--accent); transition: transform 0.15s; display: inline-block; }
  .details-toggle.open { transform: rotate(90deg); }
  .diff-table { margin-top: 8px; font-size: 11px; border-collapse: collapse; width: 100%; }
  .diff-table th { text-align: left; padding: 4px 8px; color: var(--text2); font-weight: 500; font-size: 10px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
  .diff-table td { padding: 4px 8px; border-bottom: 1px solid rgba(51,54,74,0.5); vertical-align: top; }
  .diff-field { color: var(--accent); font-weight: 500; white-space: nowrap; }
  .diff-before { color: var(--red); opacity: 0.85; max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
  .diff-after { color: var(--green); max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
  .diff-hint { color: var(--orange); font-size: 10px; font-style: italic; }
  .diff-section-label { color: var(--text2); font-weight: 600; font-size: 11px; padding-top: 6px; }

  /* Loading & empty */
  .loading, .empty { text-align: center; padding: 60px 0; color: var(--text2); font-size: 14px; }
  .loading::after { content: '...'; animation: dots 1s infinite; }
  @keyframes dots { 0%,20% { content: '.'; } 40% { content: '..'; } 60%,100% { content: '...'; } }
</style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const API_URL = window.API_URL || 'https://capacity-planner-production-1cf7.up.railway.app';
const GOOGLE_CLIENT_ID = '487456084105-01l0m47e7up61qb40sf2v7gtjmrp6hqt.apps.googleusercontent.com';
const ALLOWED_DOMAIN = 'novibet.com';
const GOOGLE_AUTH_KEY = 'cp_google_auth';

function decodeJwt(token) {
  try {
    const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(atob(base64));
  } catch { return null; }
}

function getStoredGoogleAuth() {
  try {
    const stored = localStorage.getItem(GOOGLE_AUTH_KEY);
    if (!stored) return null;
    const data = JSON.parse(stored);
    if (data.exp && data.exp * 1000 < Date.now() + 300000) {
      localStorage.removeItem(GOOGLE_AUTH_KEY);
      return null;
    }
    if (!data.email || !data.email.endsWith('@' + ALLOWED_DOMAIN)) {
      localStorage.removeItem(GOOGLE_AUTH_KEY);
      return null;
    }
    return data;
  } catch { return null; }
}

function AuthGate({ children }) {
  const [user, setUser] = useState(getStoredGoogleAuth);
  const googleBtnRef = useRef(null);

  useEffect(() => {
    if (user) return;
    const initGoogle = () => {
      if (!window.google?.accounts?.id) { setTimeout(initGoogle, 200); return; }
      window.google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: (response) => {
          const payload = decodeJwt(response.credential);
          if (!payload?.email?.endsWith('@' + ALLOWED_DOMAIN)) {
            alert('Access denied. Use your company account.');
            return;
          }
          const userData = { email: payload.email, name: payload.name, picture: payload.picture, exp: payload.exp, credential: response.credential };
          localStorage.setItem(GOOGLE_AUTH_KEY, JSON.stringify(userData));
          setUser(userData);
        },
        auto_select: true,
      });
      if (googleBtnRef.current) {
        window.google.accounts.id.renderButton(googleBtnRef.current, { theme: 'filled_black', size: 'large', shape: 'pill' });
      }
    };
    initGoogle();
  }, [user]);

  if (!user) {
    return (
      <div className="auth-gate">
        <h2>Sign in with your company account</h2>
        <div ref={googleBtnRef} />
      </div>
    );
  }

  return children(user, () => {
    localStorage.removeItem(GOOGLE_AUTH_KEY);
    window.google?.accounts?.id?.disableAutoSelect();
    setUser(null);
  });
}

function DiffDetails({ diffs }) {
  if (!diffs || diffs.length === 0) return null;
  return (
    <table className="diff-table">
      <thead><tr><th>Field</th><th>Before</th><th>After</th></tr></thead>
      <tbody>
        {diffs.map((diff, di) => (
          <React.Fragment key={di}>
            {diff.changes && diff.changes.length > 0 ? (
              <>
                <tr><td colSpan={3} className="diff-section-label">{diff.field}</td></tr>
                {diff.changes.map((c, ci) => (
                  <tr key={ci}>
                    <td className="diff-field">{c.label}</td>
                    <td className="diff-before" title={typeof c.before === 'string' ? c.before : JSON.stringify(c.before)}>{c.before === undefined ? '‚Äî' : String(c.before)}</td>
                    <td className="diff-after" title={typeof c.after === 'string' ? c.after : JSON.stringify(c.after)}>
                      {c.after === undefined ? '‚Äî' : String(c.after)}
                      {c.hint && <span className="diff-hint"> ({c.hint})</span>}
                    </td>
                  </tr>
                ))}
              </>
            ) : (
              <tr><td className="diff-field">{diff.field}</td><td className="diff-before">‚Äî</td><td className="diff-after">changed</td></tr>
            )}
          </React.Fragment>
        ))}
      </tbody>
    </table>
  );
}

function AuditLog({ user, onLogout }) {
  const [entries, setEntries] = useState([]);
  const [total, setTotal] = useState(0);
  const [loading, setLoading] = useState(true);
  const [filterUser, setFilterUser] = useState('');
  const [filterVertical, setFilterVertical] = useState('');
  const [filterDays, setFilterDays] = useState('30');
  const [expandedIds, setExpandedIds] = useState(new Set());

  const toggleExpand = (id) => {
    setExpandedIds(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      return next;
    });
  };

  const fetchLog = useCallback(async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (filterUser) params.set('user', filterUser);
      if (filterVertical) params.set('vertical', filterVertical);
      if (filterDays) params.set('days', filterDays);
      const resp = await fetch(`${API_URL}/api/audit-log?${params}`);
      const data = await resp.json();
      setEntries(data.entries || []);
      setTotal(data.total || 0);
    } catch (e) {
      console.error('Failed to fetch audit log:', e);
    } finally {
      setLoading(false);
    }
  }, [filterUser, filterVertical, filterDays]);

  useEffect(() => { fetchLog(); }, [fetchLog]);

  // Extract unique users & verticals for filter dropdowns
  const uniqueUsers = [...new Set(entries.map(e => e.userName).filter(n => n && n !== 'unknown'))];
  const verticals = ['growth', 'sportsbook', 'casino', 'account', 'payments'];

  const formatTime = (ts) => {
    const d = new Date(ts);
    const now = new Date();
    const diff = now - d;
    if (diff < 60000) return 'Just now';
    if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
    return d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' + d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div>
      <div className="header">
        <h1>
          üìã Activity Log <span>Capacity Planner</span>
        </h1>
        <div className="header-right">
          <a href="/" className="back-link">‚Üê Back to Planner</a>
          {user.picture && <img src={user.picture} referrerPolicy="no-referrer" />}
          <span className="user-name">{user.name?.split(' ')[0]}</span>
          <button className="logout-btn" onClick={onLogout}>Logout</button>
        </div>
      </div>

      <div className="filters">
        <div className="filter-group">
          <label>User:</label>
          <select value={filterUser} onChange={e => setFilterUser(e.target.value)}>
            <option value="">All users</option>
            {uniqueUsers.map(u => <option key={u} value={u}>{u}</option>)}
          </select>
        </div>
        <div className="filter-group">
          <label>Vertical:</label>
          <select value={filterVertical} onChange={e => setFilterVertical(e.target.value)}>
            <option value="">All verticals</option>
            {verticals.map(v => <option key={v} value={v}>{v.charAt(0).toUpperCase() + v.slice(1)}</option>)}
          </select>
        </div>
        <div className="filter-group">
          <label>Period:</label>
          <select value={filterDays} onChange={e => setFilterDays(e.target.value)}>
            <option value="1">Last 24 hours</option>
            <option value="7">Last 7 days</option>
            <option value="14">Last 14 days</option>
            <option value="30">Last 30 days</option>
          </select>
        </div>
        <button className="refresh-btn" onClick={fetchLog}>üîÑ Refresh</button>
        <span className="entry-count">{total} entries</span>
      </div>

      <div className="log-container">
        {loading ? (
          <div className="loading">Loading activity log</div>
        ) : entries.length === 0 ? (
          <div className="empty">No activity found for the selected filters.</div>
        ) : (
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>User</th>
                <th>Action</th>
                <th>Vertical</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {entries.map(entry => {
                const hasDiffs = entry.diffs && entry.diffs.length > 0;
                const isExpanded = expandedIds.has(entry.id);
                return (
                  <React.Fragment key={entry.id}>
                    <tr>
                      <td className="ts" title={new Date(entry.timestamp).toLocaleString()}>{formatTime(entry.timestamp)}</td>
                      <td>
                        <div className="user-cell">
                          <span>{entry.userName}</span>
                          {entry.userEmail !== 'unknown' && <span className="user-email">({entry.userEmail.split('@')[0]})</span>}
                        </div>
                      </td>
                      <td className="action-cell">{entry.action}</td>
                      <td>{entry.vertical && <span className="vertical-badge">{entry.vertical}</span>}</td>
                      <td className="details-cell">
                        {hasDiffs ? (
                          <div className="details-summary" onClick={() => toggleExpand(entry.id)}>
                            <span className={`details-toggle${isExpanded ? ' open' : ''}`}>‚ñ∂</span>
                            <span>{entry.details}</span>
                          </div>
                        ) : (
                          <span>{entry.details}</span>
                        )}
                        {hasDiffs && isExpanded && <DiffDetails diffs={entry.diffs} />}
                      </td>
                    </tr>
                  </React.Fragment>
                );
              })}
            </tbody>
          </table>
        )}
      </div>
    </div>
  );
}

function Root() {
  return (
    <AuthGate>
      {(user, onLogout) => <AuditLog user={user} onLogout={onLogout} />}
    </AuthGate>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
</script>
</body>
</html>
